{
   "Parameters":{
      "TravisUploadToS3PolicyName":{
         "Type":"String"
      },
      "TravisCDPolicyName":{
         "Type":"String"
      },
      "Resource1":{
         "Type":"String"
      },
      "Resource2":{
         "Type":"String"
      },
      "Resource3":{
         "Type":"String"
      },
      "Resource4":{
         "Type":"String"
      },
      "Resource5":{
         "Type":"String"
      },
      "BucketName":{
         "Description":"A S3 bucket name",
         "Type":"String"
      },
      "CodeDeployServiceRoleService":{
         "Type":"String"
      },
      "CodeDeployServiceRoleName":{
         "Type":"String"
      },
      "ApplicationName":{
         "Type":"String"
      }
   },
   "Resources":{
      "TravisUploadToS3Policy":{
         "Type":"AWS::IAM::ManagedPolicy",
         "Properties":{
            "PolicyDocument":{
               "Version":"2012-10-17",
               "Statement":[
                  {
                     "Effect":"Allow",
                     "Action":[
                        "s3:PutObject"
                     ],
                     "Resource":[
                        "*"
                     ]
                  }
               ]
            },
            "Users":[
               "travis-ci"
            ],
            "ManagedPolicyName":{
               "Ref":"TravisUploadToS3PolicyName"
            }
         }
      },
      "TravisCodeDeployPolicy":{
         "Type":"AWS::IAM::ManagedPolicy",
         "Properties":{
            "PolicyDocument":{
               "Version":"2012-10-17",
               "Statement":[
                  {
                     "Effect":"Allow",
                     "Action":[
                        "codedeploy:RegisterApplicationRevision",
                        "codedeploy:GetApplicationRevision"
                     ],
                     "Resource":{
                        "Ref":"Resource2"
                     }
                  },
                  {
                     "Effect":"Allow",
                     "Action":[
                        "codedeploy:CreateDeployment",
                        "codedeploy:GetDeployment"
                     ],
                     "Resource":"*"
                  },
                  {
                     "Effect":"Allow",
                     "Action":"codedeploy:GetDeploymentConfig",
                     "Resource":[
                        {
                           "Ref":"Resource3"
                        },
                        {
                           "Ref":"Resource4"
                        },
                        {
                           "Ref":"Resource5"
                        }
                     ]
                  }
               ]
            },
            "Users":[
               "travis-ci"
            ],
            "ManagedPolicyName":{
               "Ref":"TravisCDPolicyName"
            }
         }
      },
      "S3Bucket":{
         "Type":"AWS::S3::Bucket",
         "Properties":{
            "BucketName":{
               "Ref":"BucketName"
            }
         }
      },
      "CodeDeployServiceRole":{
         "Type":"AWS::IAM::Role",
         "Properties":{
            "RoleName":{
               "Ref":"CodeDeployServiceRoleName"
            },
            "ManagedPolicyArns":[
               "arn:aws:iam::aws:policy/service-role/AWSCodeDeployRole"
            ],
            "AssumeRolePolicyDocument":{
               "Version":"2012-10-17",
               "Statement":[
                  {
                     "Sid":"",
                     "Effect":"Allow",
                     "Principal":{
                        "Service":[
                           {
                              "Ref":"CodeDeployServiceRoleService"
                           }
                        ]
                     },
                     "Action":"sts:AssumeRole"
                  }
               ]
            }
         }
      },     
      "CodeDeployServiceRoleInstanceProfile":{
         "Type":"AWS::IAM::InstanceProfile",
         "Properties":{
            "Path":"/",
            "Roles":[
               {
                  "Ref":"CodeDeployServiceRole"
               }
            ]
         }
      },
      "DeploymentApplication":{
         "Type":"AWS::CodeDeploy::Application",
         "Properties":{
            "ApplicationName":{
               "Ref":"ApplicationName"
            },
            "ComputePlatform":"Server"
         }
      },
      "DeploymentGroup":{
         "Type":"AWS::CodeDeploy::DeploymentGroup",
         "Properties":{
            "ApplicationName":{
               "Ref":"ApplicationName"
            },
            "DeploymentConfigName":"CodeDeployDefault.OneAtATime",
            "DeploymentGroupName":{
               "Ref":"ApplicationName"
            },
            "DeploymentStyle":{
               "DeploymentOption":"WITHOUT_TRAFFIC_CONTROL",
               "DeploymentType":"IN_PLACE"
            },
            "Ec2TagFilters":[
               {
                  "Key":"Name",
                  "Value":"csye6225_webapp_ec2",
                  "Type":"KEY_AND_VALUE"
               }
            ],
            "ServiceRoleArn":{
               "Fn::GetAtt":[
                  "CodeDeployServiceRole",
                  "Arn"
               ]
            }
         }
      }
   }
}

